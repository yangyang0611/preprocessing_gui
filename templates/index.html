<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Preprocessing</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 30px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: white;
            display: flex;
            flex-direction: column;
        }

        .form-container {
            display: flex;
            flex-direction: row;
        }

        .form-section, .steps-section {
            flex: 1;
            margin: 10px;
        }

        .drop-zone {
            width: 100%;
            height: 200px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .drop-zone.dragover {
            border-color: #007BFF;
            background-color: #e6f7ff;
        }

        .file-input {
            display: none;
        }

        .sortable-list {
            list-style-type: none;
            padding: 0;
            margin-top: 15px;
        }

        .sortable-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sortable-item.dragging {
            opacity: 0.5;
        }

        #uploadStatus {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        #uploadStatus.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        #uploadStatus.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        #downloadLink {
            display: block;
            margin-top: 10px;
            color: #007BFF;
            text-decoration: none;
        }

        #downloadLink:hover {
            text-decoration: underline;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .progress {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 0%;
        }

        .btn-block[disabled] {
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Image Preprocessing</h1>
        <div class="drop-zone" id="drop-zone">
            <p>Drag & Drop Files or Folder Here</p>
            <p>or</p>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Select File or Folder</button>
        </div>
        <input type="file" id="fileInput" class="file-input" webkitdirectory directory multiple>
        <div id="uploadStatus"></div>

        <div class="form-container">
            <div class="form-section">
                <h3>Functions</h3>
                <div class="form-group">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="resize">
                        <label class="custom-control-label" for="resize">Resize</label>
                    </div>
                    <div id="resizeInputs" style="display: none;">
                        <input type="number" id="resizeWidth" class="form-control mt-2" placeholder="Width">
                        <input type="number" id="resizeHeight" class="form-control mt-2" placeholder="Height">
                    </div>
                </div>

                <div class="form-group">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="rotate">
                        <label class="custom-control-label" for="rotate">Rotate</label>
                    </div>
                    <div id="rotateInputs" style="display: none;">
                        <select id="rotateAngle" class="form-control mt-2">
                            <option value="90">90 degrees</option>
                            <option value="180">180 degrees</option>
                            <option value="270">270 degrees</option>
                        </select>
                    </div>
                </div>

                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="mirror">
                    <label class="custom-control-label" for="mirror">Mirror</label>
                </div>

                <div class="form-group mt-2">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="addnoise">
                        <label class="custom-control-label" for="addnoise">Add Noise</label>
                    </div>
                    <div id="noiseInputs" style="display: none;">
                        <select class="form-control mt-2" id="noiseType">
                            <option value="Gaussian">Gaussian</option>
                            <option value="Brightness">Brightness</option>
                            <option value="Saturation">Saturation</option>
                        </select>
                        <div id="gaussianInputs" style="display: none;">
                            <input type="number" id="noiseMean" class="form-control mt-2" placeholder="Mean (for Gaussian)">
                            <input type="number" id="noiseStd" class="form-control mt-2" placeholder="Standard Deviation (for Gaussian)" step="0.1" min="0" max="1">
                        </div>
                        <div id="brightnessInputs" style="display: none;">
                            <input type="number" id="brightnessFactor" class="form-control mt-2" placeholder="Brightness Factor" step="0.1" min="0.5" max="1.5">
                        </div>
                        <div id="saturationInputs" style="display: none;">
                            <input type="number" id="saturationFactor" class="form-control mt-2" placeholder="Saturation Factor" step="0.1" min="0.5" max="1.5">
                        </div>
                    </div>
                </div>
            </div>

            <div class="steps-section">
                <h3>Processing Steps</h3>
                <ul id="sortable-list" class="sortable-list"></ul>
            </div>
        </div>

        <button class="btn btn-success btn-block mt-3" onclick="addStep()">Add Step</button>
        <button class="btn btn-primary btn-block mt-3" onclick="processImage()">Proceed</button>

        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        <button id="downloadDataset" class="btn btn-info btn-block mt-3" disabled onclick="downloadDataset()">Download Dataset</button>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        let uploadedFile;
        let datasetFilename;

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length) {
                uploadFiles(files);
            }
        }

        function uploadFiles(files) {
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            fetch('http://localhost:5000/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        showUploadStatus(true, `Files uploaded successfully!`);
                        datasetFilename = data.datasetFilename;
                    }
                })
                .catch(error => {
                    showUploadStatus(false, 'Error uploading files');
                });
        }

        function showUploadStatus(success, message) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = success ? 'alert alert-success' : 'alert alert-danger';
            statusDiv.style.display = 'block';
        }

        function addStep() {
            const steps = ['Resize', 'Rotate', 'Mirror', 'Add Noise'];
            steps.forEach(step => {
                const checkbox = document.getElementById(step.toLowerCase().replace(/\s+/g, ''));
                if (checkbox.checked) {
                    let params = {};
                    switch (step) {
                        case 'Resize':
                            params.width = document.getElementById('resizeWidth').value;
                            params.height = document.getElementById('resizeHeight').value;
                            document.getElementById('resizeWidth').value = '';
                            document.getElementById('resizeHeight').value = '';
                            break;
                        case 'Rotate':
                            params.angle = document.getElementById('rotateAngle').value;
                            document.getElementById('rotateAngle').value = '';
                            break;
                        case 'Mirror':
                            break;
                        case 'Add Noise':
                            params.type = document.getElementById('noiseType').value;
                            if (params.type === 'Gaussian') {
                                params.mean = document.getElementById('noiseMean').value;
                                params.std = document.getElementById('noiseStd').value;
                                document.getElementById('noiseMean').value = '';
                                document.getElementById('noiseStd').value = '';
                            } else if (params.type === 'Brightness') {
                                params.factor = document.getElementById('brightnessFactor').value;
                                document.getElementById('brightnessFactor').value = '';
                            } else if (params.type === 'Saturation') {
                                params.factor = document.getElementById('saturationFactor').value;
                                document.getElementById('saturationFactor').value = '';
                            }
                            document.getElementById('noiseType').value = 'Gaussian';
                            break;
                    }
                    addStepToList(step, params);
                    checkbox.checked = false;
                }
            });
        
            // Hide input sections
            document.getElementById('resizeInputs').style.display = 'none';
            document.getElementById('rotateInputs').style.display = 'none';
            document.getElementById('noiseInputs').style.display = 'none';
        }
        

        function addStepToList(step, params) {
            const list = document.getElementById('sortable-list');
            const newItem = document.createElement('li');
            newItem.classList.add('sortable-item', 'list-group-item');
            newItem.setAttribute('draggable', 'true');
            newItem.dataset.step = step;
            newItem.dataset.params = JSON.stringify(params);

            let paramString = Object.entries(params).map(([key, value]) => `${key}: ${value}`).join(', ');
            newItem.textContent = `${step} (${paramString})`;

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'X';
            deleteBtn.className = 'btn btn-danger btn-sm ml-2';
            deleteBtn.onclick = function() {
                list.removeChild(newItem);
            };
            newItem.appendChild(deleteBtn);

            list.appendChild(newItem);

            newItem.addEventListener('dragstart', () => newItem.classList.add('dragging'));
            newItem.addEventListener('dragend', () => newItem.classList.remove('dragging'));
        }

        function processImage() {
            if (!datasetFilename) {
                alert('Please upload a folder first.');
                return;
            }
        
            const steps = Array.from(document.querySelectorAll('.sortable-item'))
                .map(item => ({
                    step: item.dataset.step,
                    params: JSON.parse(item.dataset.params)
                }));
        
            if (steps.length === 0) {
                alert('Please add at least one processing step.');
                return;
            }
        
            const options = { sequence: steps };
            const progressBar = document.querySelector('.progress-bar');
            const progressContainer = document.querySelector('.progress');
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
        
            fetch('http://localhost:5000/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ datasetFilename, options })
            })
                .then(response => response.json())
                .then(data => {
                    progressBar.style.width = '100%';
                    progressBar.textContent = 'Processing Complete';
                    document.getElementById('downloadDataset').disabled = false;
                    alert(data.message);
                    // Update the datasetFilename with the processed dataset
                    datasetFilename = 'processed_dataset.zip'; 
                })
                .catch(error => {
                    progressBar.style.width = '0%';
                    alert('Error processing images');
                });
        }
        
        function downloadDataset() {
            if (datasetFilename) {
                const downloadLink = document.createElement('a');
                downloadLink.href = `http://localhost:5000/download/processed_dataset.zip`;
                downloadLink.download = 'processed_dataset.zip';
                downloadLink.click();
            }
        }

        // Add event listeners to enable/disable input fields
        document.getElementById('resize').addEventListener('change', function() {
            document.getElementById('resizeInputs').style.display = this.checked ? 'block' : 'none';
        });
        
        document.getElementById('rotate').addEventListener('change', function() {
            document.getElementById('rotateInputs').style.display = this.checked ? 'block' : 'none';
        });
        
        document.getElementById('addnoise').addEventListener('change', function() {
            document.getElementById('noiseInputs').style.display = this.checked ? 'block' : 'none';
            updateNoiseInputs();
        });
        
        function updateNoiseInputs() {
            const noiseType = document.getElementById('noiseType').value;
            document.getElementById('gaussianInputs').style.display = noiseType === 'Gaussian' ? 'block' : 'none';
            document.getElementById('brightnessInputs').style.display = noiseType === 'Brightness' ? 'block' : 'none';
            document.getElementById('saturationInputs').style.display = noiseType === 'Saturation' ? 'block' : 'none';
        }
        
        document.getElementById('noiseType').addEventListener('change', updateNoiseInputs);

        // sorted the list by drag and drop Functions
        const sortableList = document.getElementById('sortable-list');

        sortableList.addEventListener('dragover', (e) => {
            e.preventDefault();
            const dragging = document.querySelector('.dragging');
            const afterElement = getDragAfterElement(sortableList, e.clientY);
            if (afterElement == null) {
                sortableList.appendChild(dragging);
            } else {
                sortableList.insertBefore(dragging, afterElement);
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.sortable-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return {
                        offset: offset,
                        element: child
                    };
                } else {
                    return closest;
                }
            }, {
                offset: Number.NEGATIVE_INFINITY
            }).element;
        }
    </script>
</body>
</html>